import { ssrRenderAttrs, ssrRenderStyle } from "vue/server-renderer";
import { useSSRContext } from "vue";
import { _ as _export_sfc } from "./plugin-vue_export-helper.cc2b3d55.js";
const __pageData = JSON.parse('{"title":"Pushing Data over Email","description":"Email is still a useful transport mechanism for data (like Google Analytics, etc.), despite ftp, web services, etc. Some websites offer email for cheap, while other access can cost a lot of money. Email is also a push service, meaning you do not have to ask periodically if new data has arrived - if you do it right. Of course, that service is rather useless without an automated way to get that data into a database. Here is an introduction to the procmail program and the ancient art of the Unix mail filter.","frontmatter":{"title":"Pushing Data over Email","description":"Email is still a useful transport mechanism for data (like Google Analytics, etc.), despite ftp, web services, etc. Some websites offer email for cheap, while other access can cost a lot of money. Email is also a push service, meaning you do not have to ask periodically if new data has arrived - if you do it right. Of course, that service is rather useless without an automated way to get that data into a database. Here is an introduction to the procmail program and the ancient art of the Unix mail filter.","date":"2008-11-19T22:11:18.000Z","tags":"data","featuredImage":"https://media.eagereyes.org/media/2008/emailDog_small.jpg"},"headers":[],"relativePath":"blog/2008/pushing-data-over-email.md","filePath":"blog/2008/pushing-data-over-email.md"}');
const _sfc_main = { name: "blog/2008/pushing-data-over-email.md" };
function _sfc_ssrRender(_ctx, _push, _parent, _attrs, $props, $setup, $data, $options) {
  _push(`<div${ssrRenderAttrs(_attrs)}><p align="center"><img src="https://media.eagereyes.org/media/2008/emailDog_small.jpg" alt="email dog" width="400" height="245" border="0"></p><h1 id="pushing-data-over-email" tabindex="-1">Pushing Data over Email <a class="header-anchor" href="#pushing-data-over-email" aria-label="Permalink to &quot;Pushing Data over Email&quot;">​</a></h1><p>Email is still a useful transport mechanism for data (like Google Analytics, etc.), despite ftp, web services, etc. Some websites offer email for cheap, while other access can cost a lot of money. Email is also a push service, meaning you do not have to ask periodically if new data has arrived - if you do it right. Of course, that service is rather useless without an automated way to get that data into a database. Here is an introduction to the procmail program and the ancient art of the Unix mail filter.</p><h2 id="pushing-email" tabindex="-1">Pushing Email <a class="header-anchor" href="#pushing-email" aria-label="Permalink to &quot;Pushing Email&quot;">​</a></h2><p>But first a bit of email theory: When you send an email, your mail program contacts the mail server of the recipient (or an intermediary mail server, which then does the same), and tells it the sender, recipient, content, etc. of the email. The email is thus &#39;pushed&#39; to the recipient&#39;s mail server, a process that typically takes a few seconds (depending on the size of the email).</p><p>This is similar to the way a letter or parcel is sent. The letter is transported to the recipient&#39;s mailbox and left there. Just like we have to check the mailbox periodically to see if new mail has arrived, most people&#39;s email programs ask their mail server if there is new email every few minutes. This part is usually referred to as &#39;pull,&#39; because it requires the recipient to periodically check and retrieve the message.</p><p>But what if we were to live right next to the mailbox? Or if we could ask the friendly postman to knock on our door when we get a letter? That&#39;s the way things work when you have an account directly on the server that also acts as your mail server: a new email appears in your mailbox the moment it is delivered. Not only is the email &#39;pushed&#39; to the user, the mail server can also check if the user has left any instructions what to do when a new email arrives, like filing it depending on the sender and subject, running it through a spam filter, etc.</p><h2 id="email-filters" tabindex="-1">Email Filters <a class="header-anchor" href="#email-filters" aria-label="Permalink to &quot;Email Filters&quot;">​</a></h2><p>The mechanism for filtering email is known as the <code>.forward</code> file. This file lives in the user&#39;s home directory and is called a &quot;dot file&quot; (because it starts with a period, it is not normally shown when listing the directory). As its name suggests, it can contain one or more addresses that each email to that user is to be forwarded to – this is how simple distribution lists and functional email roles (like support, office, abuse) used to be handled. In addition, the syntax also allows the specification of a program to hand the email over to.</p><p>There are several programs for this purpose (like the aptly-named <code>vacation</code> program), the best-known of which is <code>procmail</code>. Procmail uses a further dot file, <code>.procmailrc</code>, to specify conditions and actions to be performed when an email matches those conditions. This is a lot more flexible than a simple forward list, and provides actions such as moving an email to a particular folder, discarding it, or handing it over to yet another program.</p><h2 id="the-setup" tabindex="-1">The Setup <a class="header-anchor" href="#the-setup" aria-label="Permalink to &quot;The Setup&quot;">​</a></h2><p>What I will describe in the following is a particular setup that I use for collecting data sent through email. To use this, you will have to have access to a Unix/Linux host, shell access (it&#39;s possible to do these things without shell access, but difficult to debug when things don&#39;t work), and some familiarity with the Unix command line. If you are running your own server, you have to have a mail transfer agent set up and accepting email.</p><p>I get the data emailed to a Gmail account, which stores it as a backup and forwards it to my actual data collection account. This is important because it means that I don&#39;t have to go to great lengths to check for errors (i can always re-forward my backup), and it also hides my data collection email address.</p><p>When an email is received by the data collector that matches the criteria (i.e., coming from a particular address and correct subject), it is run through a filter that extracts any attachments and stores them in a particular directory, and is then discarded. Of course, the same mechanism could also be used to do things like run a <a href="http://flowingdata.com/2008/11/05/how-to-make-your-own-twitter-bot-python-implementation/">Twitter bot</a>.</p><p>Other scripts are run in a cron job to pick up the files and push them into a database or do other things with them. The reason for this is that I want to do as little as possible in the actual mail filter, to reduce complexity and sources for errors.</p><h2 id="procmail" tabindex="-1">Procmail <a class="header-anchor" href="#procmail" aria-label="Permalink to &quot;Procmail&quot;">​</a></h2><p>Like many Unix programs, <a href="http://www.procmail.org/">procmail</a> has been around for many, many years (the first version was released in December 1990). Its age does not take away from its functionality, but it does explain the cryptic definition file syntax. Documentation is also largely cryptic; there is a <a href="http://www.ii.com/internet/robots/procmail/qs/">very readable introduction</a>, but it&#39;s also rather long to cover all the program&#39;s options.</p><p>The first step in using procmail is to actually have it run for every email. The way this is done is with the following line in your <code>.forward</code> file:</p><blockquote><p><code>&gt;|/usr/bin/procmail</code></p></blockquote><p>Make sure the path for procmail is correct, but other than that, this is very simple. Now that procmail is being run on every email the user receives, we have to write the rules for it. This is what such a rule (stored in <code>.procmailrc</code>) looks like:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">\`:0</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">* ^Subject: (Fwd: )?Analytics eagereyes.org</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">| bin/extractAttachments.py /tmp/data/www</span></span></code></pre></div><p>The first line starts the rule and allows a number of flags (like c for making a copy of the mail, so it can be processed by further rules even if this one matches). The second line contains a condition, which is a <a href="http://en.wikipedia.org/wiki/Regular_expression">regular expression</a>. Any header field can be used here, and several conditions can be put on separate lines, which all have to be met for the rule to become active. The last line specifies the action, which in this case is to run a program. As the use of the pipe character (<span style="${ssrRenderStyle({ "font-family": "terminal, monaco" })}">|</span>) suggests, the program will receive the email through its standard input stream (stdin).</p><p>Any program can be run in a procmail rule, just like it were run from the shell. Commands can also be passed, like in this case the directory for storing the data – which might be different for different data sources.</p><p>Testing the procmail rule can be done by running procmail and passing it an email through stdin. Here I am using the mbox file created by the ancient <span style="${ssrRenderStyle({ "font-family": "terminal, monaco" })}">mail</span> program. More user-friendly ones (like <span style="${ssrRenderStyle({ "font-family": "terminal, monaco" })}">pine</span>) are usually available, and can also export emails.</p><blockquote><p><code>procmail &lt; mbox</code></p></blockquote><p>If the rule works and the script does its thing correctly, the attachment will now be a file in the right directory. The next step is to send a new email with attachment to the address and see if things work. If they do, the email will not show up in the inbox, only the attachment will appear in the directory (procmail is only run automatically on new emails).</p><h2 id="the-attachment-extractor-script" tabindex="-1">The Attachment Extractor Script <a class="header-anchor" href="#the-attachment-extractor-script" aria-label="Permalink to &quot;The Attachment Extractor Script&quot;">​</a></h2><p>The script below is a very simple Python program that extracts any attachments from an email and stores them in a directory. It makes good use of the excellent libraries that are included in Python, but performs no error checking whatsoever. If the email is not well-formed, or the attachment is not base64-encoded (which is very unusual in this day and age, however), it will silently fail. Despite that, it works well for its purpose, and lets me collect data that would otherwise require a lot of manual effort.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">#! /usr/bin/python</span></span>
<span class="line"></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">&quot;&quot;&quot;</span><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}"> Extract attachments from emails and store them as files.</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">    Command-line argument: target directory</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">    Stdin: email text (e.g., through procmail)</span></span>
<span class="line"></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">    This script performs no error checking and assumes that anything with</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">    a filename will be base64-encoded. This is really only meant to collect</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#676E95", "font-style": "italic" })}">    data that is emailed automatically. Test well and use at your own risk.</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">import</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> sys</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">import</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> email</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#F07178" })}">parser</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">import</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> base64</span></span>
<span class="line"></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">BASEDIR </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">=</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> sys</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#F07178" })}">argv</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">[</span><span style="${ssrRenderStyle({ "color": "#F78C6C" })}">1</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">]</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">+</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">&#39;</span><span style="${ssrRenderStyle({ "color": "#C3E88D" })}">/</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">parser </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">=</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> email</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#F07178" })}">parser</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">Parser</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">()</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">mail </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">=</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> parser</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">parse</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">sys</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#F07178" })}">stdin</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">)</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">if</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> mail</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">is_multipart</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">():</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">	</span><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">for</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> m </span><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">in</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> mail</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">get_payload</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">():</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">		</span><span style="${ssrRenderStyle({ "color": "#89DDFF", "font-style": "italic" })}">if</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">m</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">get_filename</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">()</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">!=</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">None):</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">			file </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">=</span><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}"> </span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">open</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">BASEDIR </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">+</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}"> m</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">get_filename</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(),</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}"> </span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">&#39;</span><span style="${ssrRenderStyle({ "color": "#C3E88D" })}">w</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">&#39;</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">)</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">			file</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">write</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">base64</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">b64decode</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">(</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">m</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">get_payload</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">()))</span></span>
<span class="line"><span style="${ssrRenderStyle({ "color": "#A6ACCD" })}">			file</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">.</span><span style="${ssrRenderStyle({ "color": "#82AAFF" })}">close</span><span style="${ssrRenderStyle({ "color": "#89DDFF" })}">()</span></span></code></pre></div><p><em>Posted by <a href="/about">Robert Kosara</a> on November 19, 2008</em></p></div>`);
}
const _sfc_setup = _sfc_main.setup;
_sfc_main.setup = (props, ctx) => {
  const ssrContext = useSSRContext();
  (ssrContext.modules || (ssrContext.modules = /* @__PURE__ */ new Set())).add("blog/2008/pushing-data-over-email.md");
  return _sfc_setup ? _sfc_setup(props, ctx) : void 0;
};
const pushingDataOverEmail = /* @__PURE__ */ _export_sfc(_sfc_main, [["ssrRender", _sfc_ssrRender]]);
export {
  __pageData,
  pushingDataOverEmail as default
};
